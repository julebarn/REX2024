import cv2
import numpy
from robot import Robot 
from functools import partial
import time
try:
    from picamera2 import Picamera2, Preview
    print("Camera.py: Using picamera2 module")
except ImportError:
    print("Camera.py: picamera2 module not available")
    exit(-1)


aruco_dict = cv2.aruco.Dictionary_get(cv2.aruco.DICT_6X6_250)
parameters = cv2.aruco.DetectorParameters_create()

bias = -0.043750000000000004
speed = 100

def goLine():
    arlo.go_diff(speed * (1+bias),speed * (1-bias), 1, 1)

def rotateUntil(pred, max_i=1000, agent=None):
    v = .34
    agent.go_diff(v*speed * (1+bias), v*speed * (1-bias), 0, 1)


    i = 0
    go = not True
    while not go:
        agent.stop()
        time.sleep(.04)
        go = pred()
        agent.go_diff(v*speed * (1+bias), v*speed * (1-bias), 0, 1)

        time.sleep(0.01)
        i += 1

    agent.stop()

def foundLandmark(cam=None):
    img = cam.capture_array()
    img = cv2.cvtColor(img, cv2.COLOR_RGB2BGR)
    _, ids, _ = cv2.aruco.detectMarkers(img, aruco_dict, parameters=parameters)
    print(ids)
    return ids != None

def main():
    print("main")
    arlo = Robot()
    
    cam = Picamera2()
    camera_config = cam.create_preview_configuration()
    cam.configure(camera_config)
    cam.start_preview(Preview.QTGL)
    cam.start()
    
    print("Out")
    img = cam.capture_array()
    img = cv2.cvtColor(img, cv2.COLOR_RGB2BGR)
    cv2.imshow('Detected Markers', img)

    rotateUntil(partial(foundLandmark, cam), agent=arlo)

    while True:
        print("while")
        img = cam.capture_array()
        img = cv2.cvtColor(img, cv2.COLOR_RGB2BGR)
    
        corners, ids, rejectedImgPoints = cv2.aruco.detectMarkers(img, aruco_dict, parameters=parameters)

        if ids is not None:
            print(len(ids))
        
        time.sleep(0.4)        

if __name__ == "__main__":
    main()
